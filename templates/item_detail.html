{% extends "base.html" %}
{% block content %}
<div class="row g-3">
  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>جزئیات وسیله</strong></div>
      <div class="card-body">
        <div class="mb-2"><strong>نام:</strong> {{ item.name }}</div>
        <div class="mb-2"><strong>دسته:</strong> {{ item.category.name if item.category else "-" }}</div>
        <div class="mb-2"><strong>زیردسته:</strong> {{ item.subcategory.name if item.subcategory else "-" }}</div>
        <div class="mb-2"><strong>اتاق:</strong> {{ item.room or "-" }}</div>
        <div class="mb-2"><strong>بودجه:</strong> {{ "{:,.0f}".format(item.budget or 0) }} تومان</div>
        <div class="mb-2"><strong>یادداشت:</strong> {{ item.notes or "-" }}</div>
      </div>
    </div>

    <div class="card shadow-sm mt-3">
      <div class="card-header bg-white"><strong>افزودن مدل / گزینه</strong></div>
      <div class="card-body">
        <form method="post" action="{{ url_for('add_option', item_id=item.id) }}">
          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label">برند</label>
              <input class="form-control" name="brand">
            </div>
            <div class="col-md-6">
              <label class="form-label">مدل</label>
              <input class="form-control" name="model_name">
            </div>
            <div class="col-md-6">
              <label class="form-label">قیمت (تومان)</label>
              <input type="number" step="0.01" class="form-control" name="price">
            </div>
            <div class="col-md-6">
              <label class="form-label">فروشگاه</label>
              <input class="form-control" name="store">
            </div>
            <div class="col-md-12">
              <label class="form-label">لینک</label>
              <input class="form-control ltr" name="link" placeholder="https://...">
            </div>
            <div class="col-md-12">
              <label class="form-label">ویژگی‌ها / توضیحات</label>
              <input class="form-control" name="features" placeholder="کم‌مصرف، رنگ سفید، ...">
            </div>
            <div class="col-md-4">
              <label class="form-label">امتیاز (0-10)</label>
              <input type="number" min="0" max="10" step="0.1" class="form-control" name="rating">
            </div>
            <div class="col-md-4">
              <label class="form-label">گارانتی (ماه)</label>
              <input type="number" class="form-control" name="warranty_months">
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="available" id="available">
                <label class="form-check-label" for="available">موجود</label>
              </div>
            </div>
            <div class="col-md-12">
              <label class="form-label">یادداشت</label>
              <textarea class="form-control" rows="2" name="notes"></textarea>
            </div>
          </div>
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary">افزودن گزینه</button>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">بازگشت</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-7">
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <strong>گزینه‌ها و مقایسه</strong>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>برند/مدل</th>
                <th class="text-center">قیمت</th>
                <th class="text-center">امتیاز</th>
                <th>فروشگاه</th>
                <th>ویژگی‌ها</th>
                <th class="text-center">انتخاب</th>
                <th class="text-end">عملیات</th>
              </tr>
            </thead>
            <tbody>
              {% for o in options %}
              <tr class="{% if o.selected %}selected-row{% endif %}">
                <td>
                  <div class="fw-semibold">{{ o.brand or '-' }} {{ o.model_name or '' }}</div>
                  {% if o.link %}<a class="small ltr" href="{{ o.link }}" target="_blank">{{ o.link }}</a>{% endif %}
                </td>
                <td class="text-center">
                  {% if o.price %}<span class="badge text-bg-light price-badge">{{ "{:,.0f}".format(o.price) }}</span>{%
                  else %}-{% endif %}
                </td>
                <td class="text-center">{{ o.rating or '-' }}</td>
                <td>{{ o.store or '-' }}</td>
                <td class="small">{{ o.features or '-' }}</td>
                <td class="text-center">
                  {% if o.selected %}
                  <form method="post" action="{{ url_for('unselect_option', option_id=o.id) }}">
                    <button class="btn btn-sm btn-success">✔ انتخاب شد</button>
                  </form>
                  {% else %}
                  <form method="post" action="{{ url_for('select_option', option_id=o.id) }}">
                    <button class="btn btn-sm btn-outline-primary">انتخاب</button>
                  </form>
                  {% endif %}
                </td>
                <td class="text-end">
                  <form method="post" action="{{ url_for('delete_option', option_id=o.id) }}"
                    onsubmit="return confirm('این گزینه حذف شود؟');">
                    <button class="btn btn-sm btn-outline-danger">حذف</button>
                  </form>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="7" class="text-center text-muted p-3">هنوز گزینه‌ای اضافه نشده است.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    {% if options %}
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-white"><strong>نمودار مقایسه قیمت و امتیاز</strong></div>
      <div class="card-body">
        <div class="mb-3">
          <canvas id="priceChart"></canvas>
        </div>
        <div>
          <canvas id="ratingChart"></canvas>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

{% if options %}
<script>
  const labels = {{ labels| tojson }};
  const prices = {{ prices| tojson }};
  const ratings = {{ ratings| tojson }};

  const ctx1 = document.getElementById('priceChart').getContext('2d');
  new Chart(ctx1, {
    type: 'bar',
    data: { labels: labels, datasets: [{ label: 'قیمت (تومان)', data: prices }] },
    options: {
      responsive: true,
      scales: { x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } } }
    }
  });

  const ctx2 = document.getElementById('ratingChart').getContext('2d');
  new Chart(ctx2, {
    type: 'bar',
    data: { labels: labels, datasets: [{ label: 'امتیاز (0-10)', data: ratings }] },
    options: { responsive: true }
  });
</script>
{% endif %}
{% endblock %}
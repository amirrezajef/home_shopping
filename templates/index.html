{% extends "base.html" %}
{% block content %}
<div class="row g-3">
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="text-muted mb-1">تعداد وسایل</h6>
        <div class="display-6">{{ total_items }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="text-muted mb-1">تعداد انتخاب‌شده</h6>
        <div class="display-6">{{ items_with_choice }}</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="text-muted mb-1">درصد پیشرفت</h6>
        <div class="progress" role="progressbar" aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">
          <div class="progress-bar" style="width: {{ completion }}%">{{ completion }}%</div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="text-muted mb-1">هزینه انتخاب‌ها</h6>
        <div class="h4">{{ "{:,.0f}".format(total_selected_cost) }} تومان</div>
        <div class="text-muted small">بودجه کل: {{ "{:,.0f}".format(total_budget) }} تومان</div>
      </div>
    </div>
  </div>
</div>

<!-- فیلترها -->
<div class="row g-3 mt-3">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="mb-3">فیلتر بر اساس دسته‌بندی</h6>
        <form method="get" class="row g-2">
          <div class="col-md-4">
            <select name="category" id="category-filter" class="form-select" onchange="loadSubcategories()">
              <option value="">همه دسته‌ها</option>
              {% for cat in categories %}
              <option value="{{ cat.id }}" {% if current_category==cat.id %}selected{% endif %}>{{ cat.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-4">
            <select name="subcategory" id="subcategory-filter" class="form-select">
              <option value="">همه زیردسته‌ها</option>
            </select>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-primary w-100">اعمال فیلتر</button>
          </div>
        </form>
        {% if current_category or current_subcategory %}
        <div class="mt-2">
          <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">پاک کردن فیلتر</a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-2">
  <div class="col-lg-8">
    {% if items_by_category %}
    {% for cat, items in items_by_category.items() %}
    <div class="card shadow-sm mb-3">
      <div class="card-header bg-white">
        <strong>دسته: {{ cat.name }}</strong>
        <span class="badge bg-primary ms-2">{{ items|length }} وسیله</span>
      </div>
      <div class="card-body p-0">
        <table class="table mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>نام وسیله</th>
              <th>زیردسته</th>
              <th>اتاق</th>
              <th class="text-center">بودجه</th>
              <th class="text-center">انتخاب نهایی</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for it in items %}
            {% set selected = (it.options|selectattr('selected')|list)|length > 0 %}
            <tr class="{% if selected %}selected-row{% endif %}">
              <td><a href="{{ url_for('item_detail', item_id=it.id) }}">{{ it.name }}</a></td>
              <td>{{ it.subcategory.name if it.subcategory else "-" }}</td>
              <td>{{ it.room or "-" }}</td>
              <td class="text-center">{{ "{:,.0f}".format(it.budget or 0) }}</td>
              <td class="text-center">
                {% if selected %}✔{% else %}-{% endif %}
              </td>
              <td class="text-end">
                <form method="post" action="{{ url_for('delete_item', item_id=it.id) }}"
                  onsubmit="return confirm('حذف این وسیله؟');">
                  <button class="btn btn-sm btn-outline-danger">حذف</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="card shadow-sm">
      <div class="card-body text-center text-muted py-5">
        {% if current_category or current_subcategory %}
        <h5>هیچ وسیله‌ای با فیلتر انتخاب شده یافت نشد</h5>
        <p>لطفاً فیلتر را تغییر دهید یا وسیله جدیدی اضافه کنید</p>
        {% else %}
        <h5>هنوز وسیله‌ای ثبت نشده است</h5>
        <p>برای شروع، اولین وسیله را اضافه کنید</p>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>آخرین وسایل اضافه‌شده</strong></div>
      <div class="card-body">
        <ul class="list-group list-group-flush">
          {% for it in recent_items %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <a href="{{ url_for('item_detail', item_id=it.id) }}">{{ it.name }}</a>
            <span class="badge text-bg-light">{{ it.category.name if it.category else "-" }}</span>
          </li>
          {% else %}
          <li class="list-group-item text-muted">هنوز وسیله‌ای ثبت نشده.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
    <div class="text-center mt-3">
      <a href="{{ url_for('new_item') }}" class="btn btn-primary w-100">➕ افزودن وسیله جدید</a>
    </div>
  </div>
</div>

<script>
  function loadSubcategories() {
    const categorySelect = document.getElementById('category-filter');
    const subcategorySelect = document.getElementById('subcategory-filter');
    const categoryId = categorySelect.value;

    // Reset subcategory
    subcategorySelect.innerHTML = '<option value="">همه زیردسته‌ها</option>';

    if (categoryId) {
      fetch(`/api/subcategories/${categoryId}`)
        .then(response => response.json())
        .then(data => {
          data.subcategories.forEach(sub => {
            const option = document.createElement('option');
            option.value = sub.id;
            option.textContent = sub.name;
            subcategorySelect.appendChild(option);
          });
        })
        .catch(error => console.error('Error loading subcategories:', error));
    }
  }

  // Load subcategories on page load if category is selected
  document.addEventListener('DOMContentLoaded', function () {
    const categorySelect = document.getElementById('category-filter');
    if (categorySelect.value) {
      loadSubcategories();
    }
  });
</script>
{% endblock %}